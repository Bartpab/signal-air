defmodule SignalNuisanceWeb.Surveillance.Exploitant.DashboardLive do
    use SignalNuisanceWeb, :live_view
    alias SignalNuisance.Signalement
    alias SignalNuisance.Entreprise
    alias Phoenix.LiveView.JS
    
    def mount(%{"slug" => slug} = _params, %{"client" => client} = _session, socket) do
      if connected?(socket) do
        Phoenix.PubSub.subscribe(SignalNuisance.PubSub, "global")
      end

      [entreprise] = Entreprise.liste(ou: [slug: slug])

      {:ok, socket 
        |> assign(:entreprise, entreprise)
        |> assign(:client, client |> Map.put(:as, SignalNuisance.Model.global_id(entreprise)))
        |> assign(:debounce, %{})
        |> assign(:buffer, %{signalements_fermés: [], nouveaux_signalements: []})
        |> mettre_a_jour_liste_signalements
      }
    end

    def debounce(socket, type, timeout \\ :timer.seconds(1)) do
      if socket.assigns[:debounce][type] == true do
        socket
      else
        :timer.send_interval(timeout, self(), {:debounce, type})
        socket |> assign([:debounce, type], true)
      end
    end

    def ack_debounce(socket, type) do
      socket |> assign([:debounce, type], false)
    end

    def ajouter_tampon(socket, type, value) do
      socket 
      |> assign([:buffer, type], [value | socket.assigns.buffer[type]])
    end

    def contenu_tampon(socket, type) do
      socket.assigns.buffer[type]
    end

    def vider_tampon(socket, type) do
      socket 
      |> assign([:buffer, type], [])
    end

    def mettre_a_jour_liste_signalements(%{assigns: %{client: client}} = socket) do
      signalements_en_cours = Signalement.liste(ou: [cloture: false], trier_par: {:modifie_le, :desc}, limite: 15)
      signalements_fermés   = Signalement.liste(ou: [cloture: true], trier_par: {:modifie_le, :desc}, limite: 15)

      (signalements_en_cours ++ signalements_fermés) |> Enum.each((&Signalement.ajouter_vu_par(&1.id, client.id)))
      
      socket
      |> assign(:compte_signalements_en_cours, Signalement.compte(ou: [cloture: false]))
      |> assign(:compte_signalements_fermés, Signalement.compte(ou: [cloture: true]))
      |> assign(:signalements_fermés, signalements_fermés)
      |> assign(:signalements_en_cours, signalements_en_cours) 
    end

    def handle_info(msg, %{assigns: %{signalements_fermés: signalements_fermés, signalements_en_cours: signalements_en_cours, client: client}} = socket) do
      case msg do
        {:debounce, :mettre_à_jour_liste_signalements} ->
          {:noreply, socket 
          |> mettre_a_jour_liste_signalements 
          |> ack_debounce(:mettre_à_jour_liste_signalements)
        }
        {:debounce, :envoyer_signalements_fermés_au_client} ->
          {:noreply, socket 
          |> push_event("signalements_cloturés", %{signalements: contenu_tampon(socket, :signalements_fermés)})
          |> vider_tampon(:signalements_fermés)
          |> ack_debounce(:envoyer_signalement_fermés_au_client)
          }
          {:debounce, :envoyer_nouveaux_signalements_au_client} ->
            {:noreply, socket 
            |> push_event("nouveaux_signalements", %{signalements: contenu_tampon(socket, :nouveaux_signalements)})
            |> vider_tampon(:nouveaux_signalements)
            |> ack_debounce(:envoyer_nouveaux_signalements_au_client)
            }
        %Phoenix.Socket.Broadcast {
          topic: "global", 
          event: "nouveau", 
          payload: {Signalment, signalement}
        } -> 
          Signalement.ajouter_vu_par(signalement.id, client.id)
          {:noreply, 
          {:noreply,
          socket 
          |> debounce(:mettre_à_jour_liste_signalements)
          |> debounce(:envoyer_nouveaux_signalements_au_client)
          |> ajouter_tampon(:nouveaux_signalements, signalement)
        }
          }
          %Phoenix.Socket.Broadcast {
            topic: "global", 
            event: "modification", 
            payload: {Signalement, {_id, _modifications}}
          } -> 
              {:noreply,
                socket 
                |> debounce(:mettre_à_jour_liste_signalements)
              }
        %Phoenix.Socket.Broadcast {
          topic: "global", 
          event: "cloturé", 
          payload: {Signalement, signalement_id}
        } -> 
            {:noreply,
              socket 
              |> debounce(:mettre_à_jour_liste_signalements)
              |> debounce(:envoyer_signalements_fermés_au_client)
              |> ajouter_tampon(:signalements_fermés, signalement_id)
            }
        _ -> {:noreply, socket}
      end
    end

    def handle_event(_event, _params, socket) do
      {:noreply, socket}
    end

    def to_js(signalement) do
      "{
        id: #{signalement.id},
        coords: [#{signalement.lat}, #{signalement.long}]
      }"
    end

    def render(assigns) do
      ~H"""
        <h1><%= gettext "Tableau de bord de l'entreprise %{name}", name: @entreprise.name %></h1>

        <h2><%= gettext "Carte" %></h2>
        <section id="section-carte" class="row" phx-update="ignore" phx-hook="GestionnaireCarte">
          <div id="carte" style="height: 400px">
          </div>
        </section>

        <div class="my-3 p-3 bg-body rounded shadow-sm">
          <h1 class="pb-2 mb-0"><%= gettext "Derniers signalements en cours" %> (<%= @compte_signalements_en_cours %>)</h1>
        </div>

        <%= if Enum.empty?(@signalements_en_cours) do %>
          <div class="d-flex text-muted pt-3">
            Aucun signalement en cours
          </div>
        <% end %>
        
        <%= for signalement <- @signalements_en_cours do %>
          <.live_component 
            module={SignalNuisance.Component.Signalement} 
            id={"signalement_en_cours_#{signalement.id}"} 
            client={@client} 
            signalement={signalement} 
          />
        <% end %>

        <div class="my-3 p-3 bg-body rounded shadow-sm">
          <h1 class="pb-2 mb-0"><%= gettext "Derniers signalements fermés" %> (<%= @compte_signalements_fermés %>)</h1>
        </div>

        <%= if Enum.empty?(@signalements_fermés) do %>
          <div class="d-flex text-muted pt-3">
            Aucun signalement...
          </div>
        <% end %>
        
        <%= for signalement <- @signalements_fermés do %>
          <.live_component 
            module={SignalNuisance.Component.Signalement} 
            id={"signalement_fermés_#{signalement.id}" }
            client={@client} 
            signalement={signalement} 
          />
        <% end %>

        <script type="text/javascript">
          let $component = Object.create({
            carte: null,
            async recupererGeolocalisation() {
              let coords = await recupererGeolocalisation();
              this.carte.setView([coords.latitude, coords.longitude], 16, { animation: true });     
            },
            ready() {

              var PlanIGN = L.tileLayer('https://wxs.ign.fr/{ignApiKey}/geoportail/wmts?'+
                  '&REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0&TILEMATRIXSET=PM'+
                  '&LAYER={ignLayer}&STYLE={style}&FORMAT={format}'+
                  '&TILECOL={x}&TILEROW={y}&TILEMATRIX={z}',
                  {
                    ignApiKey: 'pratique',
                    ignLayer: 'GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2',
                    style: 'normal',
                    format: 'image/png',
                    service: 'WMTS',
              });
              
              
              this.marks = [
                <%= for signalement <- SignalNuisance.Signalement.liste(ou: [cloture: false]) do %>
                  <%= to_js(signalement) %>,
                <% end %>
              ];
              
              let entreprise_coords = [<%= @entreprise.lat %>, <%= @entreprise.long %>];    
              this.carte = L.map('carte', {center: entreprise_coords, zoom: 14, layers: [PlanIGN]});         
              L.marker(entreprise_coords).addTo(this.carte);
              
              this.heat_map = this.marks.map(m => m.coords.concat([0.4]));
              this.heat = L.heatLayer(this.heat_map, {radius: 25, max: 100.0, minOpacity: 0.3}).addTo(this.carte);
            }
          });

          $(document).ready(function() {
            $component.ready();
            liveSocket.hooks.GestionnaireCarte = {
              mounted() {
                this.handleEvent("signalements_cloturés", function(payload) {
                  payload.signalements.forEach(function(signalement) {
                    this.marks = this.marks.filter(sig => sig.id != signalement.id);
                    this.heat_map = this.marks.map(m => m.coords.concat([0.4]));
                    this.heat.setLatLngs(this.heat_map);
                  }.bind(this));
                }.bind($component));
                this.handleEvent("nouveaux_signalements", function(payload) {
                  payload.signalements.forEach(function(signalement) {
                    let coords = [signalement.lat, signalement.long];
                    let mark = {
                      id: signalement.id,
                      coords: [signalement.lat, signalement.long],
                    };
                    this.marks.push(mark);
                    this.heat.addLatLng(mark.coords);
                  }.bind(this));
                }.bind($component));
              }
            };
          });
        </script>

      """
    end



end
  